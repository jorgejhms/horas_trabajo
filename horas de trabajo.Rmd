---
title: "Horas de trabajo"
output:
  flexdashboard::flex_dashboard:
    vertical_layout: scroll
    orientation: rows
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}

# Define archivo de trabajo
input_file <- here::here("horas_trabajo.csv")

# Imports
box::use(
  r/core[...],
  ./pmdr,
  dplyr[filter, mutate, group_by, summarise],
  janitor[clean_names],
  data.table[fread],
  lubridate[date, floor_date, ceiling_date, today, week, year, wday],
  flexdashboard[gauge, gaugeSectors],
  ggplot2[...]
)

Sys.setlocale(category = "LC_ALL", locale = "es_ES.UTF-8")

options("lubridate.week.start" = 1) # Establece lunes como inicio de semana

# Carga de datos ------------------------------------------------------------

df <- fread(input_file, sep = ";")

df <- df |>
  clean_names() |>
  mutate(
    inicio = as.POSIXct(inicio, format = "%d/%m/%Y %H:%M:%S"),
    fin = as.POSIXct(fin, format = "%d/%m/%Y %H:%M:%S"),
    minutos = difftime(fin, inicio, units = "min"),
    horas = (minutos / 60) |> as.numeric(),
    pomodoros = (minutos / 25) |> round() |> as.numeric(),
  )

# Variables -----------------------------------------------------------------

# Define inicio y fin de la semana
week_start <- floor_date(today(), "week")
week_end <- ceiling_date(today(), "week")
month_start  <-  floor_date(today(), "month")
month_end  <-  ceiling_date(today(), "month")

# Tabla de datos correspondiente al día de hoy
day <- df  |>
  filter(date(inicio) == today())

results_day <- day |>
  pmdr$get_results()

# Tabla de datos correspondiente a la semana actual
week <- df |>
    filter(inicio >= week_start & inicio <= week_end)

results_week <- week |>
  pmdr$get_results()

# Tabla de datos correspondiente al mes actual
month <- df |>
    filter(inicio >= month_start & inicio <= month_end)

results_month <- month |>
  pmdr$get_results()
```

## Cabecera

### Horas de trabajo en la semana

```{r}
  gauge(
    round(results_week$horas),
    min = 0,
    max = 40,
    symbol = "h",
    gaugeSectors(
      warning = c(0, 20),
      success = c(20, 30),
      danger = c(30, 40)
    )
  )
```

### Pomodoros en la semana

```{r}
  gauge(
    round(results_week$pomodoros),
    min = 0,
    max = 80,
    symbol = "🍅",
    gaugeSectors(
      warning = c(0, 40),
      success = c(40, 60),
      danger = c(60, 80)
    ))
```


### Horas de trabajo en el día

```{r}
  gauge(
    round(results_day$horas),
    min = 0,
    max = 8,
    symbol = "h",
    gaugeSectors(
      warning = c(0, 5),
      success = c(5, 6),
      danger = c(6, 8)
    )
  )
```

### Pomodoro de trabajo en el día

```{r}
  gauge(
    round(results_day$pomodoros),
    min = 0,
    max = 16,
    symbol = "🍅",
    gaugeSectors(
      warning = c(0, 8),
      success = c(8, 12),
      danger = c(12, 16)
    )
  )
```
## Todos los días

### Pomodoros
```{r fig.width = 10, fig.height = 3}
df |>
  filter(date(inicio) >= today() - 90) |>
  pmdr$plot_barras(date(inicio) |> as.factor(), pomodoros) +
  geom_hline(yintercept = 8,
             linetype = "dashed",
             color = "green3") +
  geom_hline(yintercept = 12,
             linetype = "dashed",
             color = "red")
```

## Horas por trabajo

### Horas en el último mes
```{r}
month |>
  group_by(trabajo) |>
  summarise(pomodoros = sum(pomodoros)) |>
  pmdr$plot_barras(reorder(trabajo, pomodoros), pomodoros) +
  coord_flip()
```

### En la última semana

```{r}
week  |>
  group_by(trabajo) |>
  summarise(pomodoros = sum(pomodoros)) |>
  pmdr$plot_barras(reorder(trabajo, pomodoros), pomodoros) +
  coord_flip()
```

## Horas por día

### Promedio de trabajo por día:

```{r}
df  |>
  group_by(date(inicio), week(inicio), year(inicio)) |>
  summarise(pomodoros = sum(pomodoros)) |>
  group_by(wday(`date(inicio)`)) |>
  summarise(pomodoros = mean(pomodoros, rm.na = T))  |>
  pmdr$plot_barras(`wday(\`date(inicio)\`)` |> as.factor(), pomodoros) +
  coord_flip()
```

### Trabajo por día en la última semana:

```{r}
week  |>
  group_by(date(inicio)) |>
  summarise(pomodoros = sum(pomodoros)) |>
  pmdr$plot_barras(`date(inicio)` |> as.factor(), pomodoros) +
  coord_flip()
```
